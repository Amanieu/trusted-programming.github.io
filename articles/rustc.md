---
layout: post
title: Contributions to the Rust compiler by Huawei Trusted Programming 
toc: true
---

Here is the list of the opensource contributions made by huawei employees on the [Rust compiler](https://github.com/rust-lang/rust).

### (rustc/LLVM/libc) Add support for big-endian and ILP32 variants of AArch64

This added compilation support of Rust programs for big-endian and [ILP32](https://developer.arm.com/documentation/dai0490/latest/)
variants of AArch64.  These changes enable Huawei and other hardware companies to run Rust code on networking hardware which commonly
uses these architecture variants.

It was through pull requests to [the LLVM compiler](https://reviews.llvm.org/rG21bfd068b32ece1c6fbc912208e7cd1782a8c3fc),
[the libc crate](https://github.com/rust-lang/libc/pull/2039), and [the Rust compiler itself](https://github.com/rust-lang/rust/pull/81455).

These changes introduce new end-to-end cross-compilation targets for the Rust compiler, making it easier to build Rust products for bespoke
hardware using a single command:

```bash
cargo build --target aarch64_be-unknown-linux-gnu
cargo build --target aarch64-unknown-linux-gnu_ilp32
cargo build --target aarch64_be-unknown-linux-gnu_ilp32
```

### (rustc) Fix error code checks

When the rust compiler generates an error, they have an associated code which then allows you to get more information by using `rustc --explain [ERROR_CODE]`. You can see the full list of the error codes [here](https://doc.rust-lang.org/nightly/error-index.html).

Just like a lot of things in the compiler, we need to ensure that the code doesn't become obsolete or out of date. It's very common for error codes to not be needed anymore and we need a check to be sure that they have been cleaned up correctly.

Because of some changes in the way the test suites are run, part of this check was not run because the target folder wasn't the right one. So the check was run, just not in the correct folder. With this [pull request](https://github.com/rust-lang/rust/pull/83451), it shouldn't happen again silently.

### (rustdoc/infra) Enforce rustdoc-GUI test-suite

Rustdoc has GUI tests to prevent regressions like it happened a lot in the past. We recently realized that this test-suite was not always run as it should. This [pull request](https://github.com/rust-lang/rust/pull/84586) fixes this issue.

### (infra) Enforce error codes checks

The Rust compiler uses error codes (which look like "E0111") and provide an explanation alongside them which can be seen using `rustc --explain E0111`. However, as time passes, some error codes are not used anymore and are often not cleaned up correctly. This [pull request](https://github.com/rust-lang/rust/pull/86137) ensures that they are cleaned up appropriately if they are removed by sending an error when the `tidy` check is run.

### (rustdoc/infra) Add new tool to check generated HTML

This [pull request](https://github.com/rust-lang/rust/pull/86059) adds a new test-suite to ensure that the HTML generated by rustdoc is valid. It's especially important for accessibility and prevent silent regressions.

### (rustc) Rework SESSION_GLOBALS API

Thanks to [this pull request](https://github.com/rust-lang/rust/pull/84953), we realized that the `SESSION_GLOBALS` API allowed to do invalid operations, messing up the spans. This [pull request](https://github.com/rust-lang/rust/pull/84961) fixes it by preventing to access the global static directly.

### (rustc) Implement built-in `#[cfg_eval]` attribute

This [pull request](https://github.com/rust-lang/rust/pull/82682) eagerly expands `#[cfg]` and `#[cfg_attr]` attributes to avoid `#[derive()]` without arguments being abused as a way to configure input for other attributes.

### (rustc) Add support for macro expansions in key-value attributes

This [pull request](https://github.com/rust-lang/rust/pull/78837) allows to call macros in attributes like `#[doc = include_str!("README.md")]`.

### (rustc) Add a scheme to track environment variables used during Rust compilation

This [pull request](https://github.com/rust-lang/rust/pull/71858) allows automatic rebuilds on environment variable changes.

### (rustc) Add support for `-static-pie` and `-static-shared`

This [pull request](https://github.com/rust-lang/rust/pull/71804) added support for statically linked position-independent executables (`-static-pie`) and "statically linked" shared libraries (`-static -shared`).

### (rustc) Allow parsing of `tuple.0.0`

This [pull request](https://github.com/rust-lang/rust/pull/71322) allowed `tuple.0.0` syntax to index tuples. It was previously considered as a floating point literal.

### (rustc) Stabilize fn-like proc macros in expression, pattern and statement positions

<https://github.com/rust-lang/rust/pull/68717>

### (rustc) Add `#[cfg(accessible(path))]`

This [pull request](https://github.com/rust-lang/rust/pull/69870) allows to check path accessibility at compile time.

### (rustc) Turn #[derive] into a regular macro attribute

This [pull request](https://github.com/rust-lang/rust/pull/79078) turned `#[derive]` into a a regular macro attribute, improving language consistency and simplifying the compiler.

### (rustc) Collapse `macro_rules` scope chains on the fly

This [pull request](https://github.com/rust-lang/rust/pull/78826) collapsed scope chains of `macro_rules` on the fly, allowing to significantly improve the compiler performance on `derive`-heavy crates.

### (rustc) Calculate visibilities once in resolve

This [pull request](https://github.com/rust-lang/rust/pull/78077) improved compiler performance and simplifying the logic by calculating item visibilities (`pub` and others) once and then reused.

### (rustc) Improve deprecation lint location on macro

This [pull request](https://github.com/rust-lang/rust/pull/78999) and [this one](https://github.com/rust-lang/rust/pull/73178) improve the location or lints reported at macro expansion time.

### (rustc) Improve documentation for some command line options controlling codegen and linking

In the following pull requests:

 * [-Crelocation-model](https://github.com/rust-lang/rust/pull/71490)
 * [-Ccode-model](https://github.com/rust-lang/rust/pull/72248)

### (rustc) Remove `compile-fail` test suite

This [pull request](https://github.com/rust-lang/rust/pull/80453) completely removed the `compile-fail` test suite and replaced it with user interface (UI) tests and a machine learning based tool for classifying tests into subdirectories.

### (rustc) Fix internal compiler errors

 * [Fix panic in `return_type_impl_trait`](https://github.com/rust-lang/rust/pull/86505)
 * [Fix parser error on invalid function body](https://github.com/rust-lang/rust/pull/87646)

### (rustc) Improve diagnostics

This [pull request](https://github.com/rust-lang/rust/pull/87607) added a a hint that expressions produce a value.
