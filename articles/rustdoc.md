---
layout: post
title: Contributions to the Rustdoc tool by Huawei Trusted Programming 
toc: true
---

Here is the list of the opensource contributions made by huawei employees on the [Rustdoc tool](https://github.com/rust-lang/rust/tree/master/src/librustdoc).

### Codeblock tooltip position

The goal of this [pull request](https://github.com/rust-lang/rust/pull/83393) was to fix the position of the tooltip "i" which appears when a rust documentation codeblock is marked as "ignore" or "compile_fail". You can see screenshots directly in the [pull request](https://github.com/rust-lang/rust/pull/83393).

### Add documentation for rustdoc GUI tests

There are multiple test suites to ensure that rustdoc is working as expected:
 * test/rustdoc: checks parts of the HTML and that some elements are present as expected
 * test/rustdoc-js: checks the documentation search
 * test/rustdoc-js-std: checks the documentation search (in the std specifically)
 * test/rustdoc-ui: checks the cli output (errors, warnings, etc)
 * test/rustdoc-json: checks the validity of the JSON output (you can generate either HTML or JSON)
 * test/rustdoc-gui: browse the generated HTML using a chrome instance (with the framework [browser-ui-test](https://github.com/GuillaumeGomez/browser-UI-test/))

This [pull request](https://github.com/rust-lang/rust/pull/83420) is about adding documentation about the **rustdoc-gui** test suite.

### Add a button to copy the "use statement"

It's very common, when reading an item's documentation to want to then import it into your code to use it. This [pull request](https://github.com/rust-lang/rust/pull/83721) adds a button to do it.

### Merge idents in paths to make source code pages DOM smaller

This [pull request](https://github.com/rust-lang/rust/pull/83992) ensures to not have a span for each part of a path in the source code pages (for example [here](https://docs.rs/sysinfo/0.17.0/src/sysinfo/lib.rs.html#7-283)). Before this change, for `a::b::c` we generated `<span>a</span>::<span>b</span>::<span>c</span>`, now we generate `<span>a::b::c</span>`.

### Migrate toggles into full HTML

This [pull request](https://github.com/rust-lang/rust/pull/84754) and [this one](https://github.com/rust-lang/rust/pull/85074) convert JS-generated toggles into full HTML ones. It's part of a more global process to clean all the toggles that you can see described in [this issue](https://github.com/rust-lang/rust/issues/83332). The global idea being to remove more JS for faster rendering.

A "funny" side-effect is that it actually improves the doc pages in case you disabled JS on the rustdoc pages.

### Remove unneeded call to with_default_session_globals

We recently realized that not only this function call was unneeded but also that it was messing up the spans. You can see the pull request [here](https://github.com/rust-lang/rust/pull/84953).

### Improvement for rustdoc-gui test suite output and run

This [pull request](https://github.com/rust-lang/rust/pull/85038) and [this one](https://github.com/rust-lang/rust/pull/84990) improved the rustdoc-gui test suite by alphabetically sorting the test and run all tests instead of stopping at the first failure like it used to.

### Improve search result DOM generation

It was discovered randomly that in some cases, the generated DOM was invalid (because of items' documentation). For more context, when using the rustdoc search, we generate the results with JS. This generation was mostly done using strings before, this [pull request](https://github.com/rust-lang/rust/pull/85540) changed it so that it now generates through browsers' API instead.

### Sidebar unification

This [pull request](https://github.com/rust-lang/rust/pull/84834) unify the sidebar between modules and the other items, add the crates list on all items on all "levels" and remove a duplicate "location" information on modules.

### Clean up HTML generated by rustdoc

Thanks to <https://github.com/rust-lang/rust/pull/84480>, we realized that the HTML (a.k.a. DOM) generated by rustdoc needed to be cleaned up. This [pull request](https://github.com/rust-lang/rust/pull/84703) is the clean up.

### Fixes for new DOM

A lot of changes happened on rustdoc recently and we're now catching up on bugs and adding a lot of new tests since we now have GUI tests. Here is a long and non-exhaustive list:

 * Fix HTML handling in search results description: <https://github.com/rust-lang/rust/pull/86095>
 * Fix font weight on documentation: <https://github.com/rust-lang/rust/pull/86078>
 * Fix display for search results by removing unwanted margins and font-weight: <https://github.com/rust-lang/rust/pull/86040>
 * Fix toggle on trait methods: <https://github.com/rust-lang/rust/pull/85722>
 * Fix source code line number display and make it clickable again: <https://github.com/rust-lang/rust/pull/85148>
 * Fix border radius for doc code blocks in rustdoc: <https://github.com/rust-lang/rust/pull/85174>
 * Fix display for "implementors" section: <https://github.com/rust-lang/rust/pull/85256>
 * Fix invalid `input:disabled` CSS selector: <https://github.com/rust-lang/rust/pull/85367>
 * Fix escape key handling: <https://github.com/rust-lang/rust/pull/85438>
 * Fix invalid CSS rules for `a:hover` (it was highlighting instead of underlining): <https://github.com/rust-lang/rust/pull/85470>
 * Fix search result position handling when switching result tab: <https://github.com/rust-lang/rust/pull/85506>
 * Prevent tab title to "null" if the URL is a search one: <https://github.com/rust-lang/rust/pull/85509>
 * Remove a lot of dead JS code: <https://github.com/rust-lang/rust/pull/85548>
 * Fix search result display (the item was going over its description): <https://github.com/rust-lang/rust/pull/85551>
 * Put back special search result items information: <https://github.com/rust-lang/rust/pull/85568>
 * Fix "inherent implementations" display (they were collapsed by default, which was wrong): <https://github.com/rust-lang/rust/pull/85602>
 * Move special search result item handling from CSS to JS: <https://github.com/rust-lang/rust/pull/85631>

### Improve generated DOM

We started using the `tidy` tool to ensure the HTML rustdoc generates is valid. The final part of this fix is in [this pull request](https://github.com/rust-lang/rust/pull/85972).

### Better search result DOM generation

When you use rustdoc search system, it'll go through the items, find the best matches and then display them. The display part was generated inside a big string before, which allowed a lot of issues. Instead, it was replaced with much safer DOM generation using browsers' API to create DOM elements. You can see how in [this pull request](https://github.com/rust-lang/rust/pull/85540).

### Don't mark "safe" intrinsics as unsafe

Some rust intrinsics are safe to be used. This [pull request](https://github.com/rust-lang/rust/pull/86327) propagates this change to rustdoc.

### Add --nocapture option to rustdoc

Until [this pull request](https://github.com/rust-lang/rust/pull/86230) was merged, there was no way to see the output of the doctests. This is now possible by using the `--nocapture` option when running `rustdoc --test`.

### Add support for tuple struct field documentation

Before this [pull request](https://github.com/rust-lang/rust/pull/87451), it was not possible to do this:

```rust
pub struct Tuple(
    /// Not this.
    u32,
    /// Not that either.
    i8,
);

// Nor this:

pub enum Enum {
    Tuple(
        /// Not this.
        u8,
    /// Not that either.
        char,
    ),
}
```

### Generate links to definition in rustdoc source code pages

This [pull request](https://github.com/rust-lang/rust/pull/84176) adds a the possibility to jump to an item definitions from the rustdoc source code pages (you can see a video in the pull request description). It got a lot of support from rust users as you can see from this twitter feed:

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">I&#39;m very excited to show some feature I&#39;m working on in <a href="https://twitter.com/rustlang?ref_src=twsrc%5Etfw">@rustlang</a>&#39;s rustdoc: ever wanted to be able to jump to a type definition from the source code pages directly? It&#39;ll be possible soon! More to come! Here is a small preview: <a href="https://t.co/ICPXH35Q8V">pic.twitter.com/ICPXH35Q8V</a></p>&mdash; Guillaume Gomez (@imperioworld_) <a href="https://twitter.com/imperioworld_/status/1379506735094857728?ref_src=twsrc%5Etfw">April 6, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

### Improve intra-doc errors

The intra-doc feature in rustdoc allows to generate links to an item without giving a full path. For example:

```rust
/// I link to [Bar].
pub struct Foo;

/// I link to [Foo].
pub enum Bar {
    U,
}
```

In this case, the rustdoc will generate links to `Foo` and `Bar` on its own.

This [pull request](https://github.com/rust-lang/rust/pull/87285) improves the error in case rustdoc cannot generate the link on its own.

### Fix rendering of reexported macros 2.0 and fix visibility of reexported items

Macros 2.0 adds a new syntax to declare macros. Rustdoc didn't make the difference between the new and old macros and rendered both the same way. This [pull request](https://github.com/rust-lang/rust/pull/86841) fixed it and also fixed the visibility rendering on reexported items.

### Fix union keyword highlighting in rustdoc HTML sources

The `union` keyword has a different meaning depending where it's used. Rustdoc simply didn't take this situation into account, prevent the `union` keyword to have the correct highlighting. This [pull request](https://github.com/rust-lang/rust/pull/87428) fixes this issue.

### Remove whitespaces in doctests' name

In case you have a code like this:

```rust
struct Iter2<T, P>(T, P);

impl<T, P> Iter2<T, P> {
    ///```
    ///assert!(true)
    ///```
    fn len() {}
}
```

If you run `rustdoc --test`, you'll get:

```console
test foo.rs - Iter2<T, P>::len (line 13) ... ok
```

But if you try to use filter to only run this test (in case you have others) like this:

```console
rustdoc --test --test-args 'Iter2<T, P>::len'
```

It'll be ignored because of the whitespace. To go around this limitation, we removed the whitespaces from the doc tests' name, which gives:

```console
test foo.rs - Iter2<T,P>::len (line 13) ... ok
```

So you can now filter using:

```console
rustdoc --test --test-args 'Iter2<T,P>::len'
```

This was done in [this pull request](https://github.com/rust-lang/rust/pull/89422).

### Enable "generate-link-to-definition" option on compiler crates and tools documentation by default

So now, when you browse [compiler documentation](https://doc.rust-lang.org/nightly/nightly-rustc/rustc_ast/index.html)'s source code, the feature will be enabled.

It was done in [this pull request](https://github.com/rust-lang/rust/pull/89217).

### Fix generics where bounds order

On reexported items, the bounds were badly sorted because of how we handled the sort in rustdoc. This [pull request](https://github.com/rust-lang/rust/pull/89098) fixed it.

The inner explanation is as follows: tokens are not represented as strings but as indexes over a huge token dictionary (this index is a `Symbol`). We were sorting over the `Symbol` type instead of keeping the original order.

### Add rustdoc version into the help popup

It can be useful sometimes to know which version of rustdoc was used to generate the documentation. You can now see this version inside the help popup. More information in the [pull request](https://github.com/rust-lang/rust/pull/88964).

### Fix table display in doc blocks

This [pull request](https://github.com/rust-lang/rust/pull/88742) fixed the rendering of `<table>` elements inside the doc blocks when their width was bigger than the doc block's (breaking the display).

### Add "doc(test(...))" attribute checks

This [pull request](https://github.com/rust-lang/rust/pull/87728) added checks on the `doc(test(...))` attributes to ensure that they were valid and to also let users know in case something was wrong instead of silently ignoring it.

### Fix bug with `#[doc]` string single-character last lines

If the last line of a file imported in a doc comment contained only one character, the line was removed. This is a very old bug which remained unnoticed for years. It was fixed in this [pull request](https://github.com/rust-lang/rust/pull/90657).

### Show all Deref implementations recursively

When you implement the `Deref` trait on a type, the `Deref` target can itself implements `Deref`, giving the original type access to the methods of the target and of the target's target.

For example, if you implement `Deref` with `PathBuf` as target, you'll also have access to `Path`'s methods because `PathBuf` implements `Deref` with `Path` as target.

The problem was that rustdoc was only showing the direct implementation and not its children, meaning that a lot of information was missing in the documentation pages. This was fixed in this [pull request](https://github.com/rust-lang/rust/pull/90183).

### Make cfg imply `doc(cfg)`

When reading documentation, it is useful to know which `cfg` is needed to be able to have access to the item. Before this [pull request](https://github.com/rust-lang/rust/pull/89596), you needed to add the `doc(cfg)` attributes yourself. Now it's done automatically by rustdoc.

### Refactoring/improvements of rustdoc UI

We made a lot of changes in the UI to improve the browsing experience for our users while making the maintenance easier for rustdoc contributors. It is composed of multiple pull requests (the first one is the start of the big changes):

 * <https://github.com/rust-lang/rust/pull/91356>
 * <https://github.com/rust-lang/rust/pull/92764>
 * <https://github.com/rust-lang/rust/pull/92937>
 * <https://github.com/rust-lang/rust/pull/92673>
 * <https://github.com/rust-lang/rust/pull/92610>
 * <https://github.com/rust-lang/rust/pull/92404>
 * <https://github.com/rust-lang/rust/pull/92440>
 * <https://github.com/rust-lang/rust/pull/91905>
 * <https://github.com/rust-lang/rust/pull/91223>
 * <https://github.com/rust-lang/rust/pull/91225>
 * <https://github.com/rust-lang/rust/pull/91179>
 * <https://github.com/rust-lang/rust/pull/90983>
 * <https://github.com/rust-lang/rust/pull/90571>

### Fix invalid line removal in doc comments with different kinds

In case you have a doc comment composed of different kind of doc comments like:

```rust
/// this is a doc comment
#[doc = "still the same doc comment!"]
/** yes, still the same */
```

The newlines were deleted at the beginning and at the end whereas they shouldn't have. This [pull request](https://github.com/rust-lang/rust/pull/92357) fixed it.

### Fix `legacy_const_generic` display

We fixed the display of this feature in this [pull request](https://github.com/rust-lang/rust/pull/89954).

### Fix const deref methods display

Methods from `Deref` cannot be called in const context and therefore shouldn't be displayed as const. This is fixed in this [pull request](https://github.com/rust-lang/rust/pull/91291).

### Fix panic when handling intra doc links generated from macro

The problem here was that we were trying to get the position of the link from the generated macro, except that it "doesn't exist" since it comes from another place. Instead of panicking, we simply try our best to render it. It was fixed in this [pull request](https://github.com/rust-lang/rust/pull/94478).

### Fix duplicated impl links in the sidebar

If two implementations have a somewhat similar form, they get generated with two different IDs. However, it wasn't the case in the sidebar. This [pull request](https://github.com/rust-lang/rust/pull/94417) fixed it.

### Fix infinite redirection generation

If a reexported item was in the same module, we were generating a file which was redirecting to itself, making it an infinite page reload. It was fixed in this [pull request](https://github.com/rust-lang/rust/pull/94260).

### Add crate filter parameter in URL

This [pull request](https://github.com/rust-lang/rust/pull/92735) added the filtering search crate as a URL parameter so you can better give it to someone else.

### Prevent lifetime elision in type alias

In type aliases, the lifetime time was elided. This [pull request](https://github.com/rust-lang/rust/pull/93542) fixed it.

### Fix star handling in block doc comments

Little explanation first: when we merge doc comment kinds for example in:

```rust
/// he
/**
* hello
*/
#[doc = "boom"]
```

We don't want to remove the empty lines between them. However, to correctly compute the "horizontal trim", we still need it, so instead, I put back a part of the "vertical trim" directly in the "horizontal trim" computation so it doesn't impact the output buffer but allows us to correctly handle the stars.

It was fixed in this [pull request](https://github.com/rust-lang/rust/pull/93038).

### Fix ICE for empty doc comment with a backline

When a doc comment was only containing a backline, it was triggering an internal compiler error. It was fixed in [this pull request](https://github.com/rust-lang/rust/pull/95804).

### Fix item information display overflow

In some cases, the item information was overflowing its parent, breaking the layout. It was fixed in [this pull request](https://github.com/rust-lang/rust/pull/95684).

### Fix intra doc link ICE on primitive

Some traits were missing for primitive types, triggering an internal compiler error when you used them. It was fixed in [this pull request](https://github.com/rust-lang/rust/pull/95645).

### Fix attribute string literals rendered with backslashes

With the following code:

```rust
#[must_use = "this is a \
              message"]
pub fn f() {}
```

rustdoc was rendering the backslash too whereas it shouldn't. It was fixed in [this pull request](https://github.com/rust-lang/rust/pull/95613).

### Fix bad handling of hidden multiline attributes

If you had a code example in a code example looking like this (note the `#` starting the two lines):

```
# #![cfg_attr(not(dox), feature(cfg_target_feature, target_feature,
# stdsimd))]
```

rustdoc was considering them as two different items, hence generating invalid code because rustdoc handles module attributes differently when generating doctests. It was fixed in [this pull request](https://github.com/rust-lang/rust/pull/95590).

### Remove header field from clean::Function

This [pull request](https://github.com/rust-lang/rust/pull/95096) removed a field from a rustdoc type, allowing to improve performance (up to 1.4%).

### Fix rustdoc handling of auto traits

Auto traits were missing the negative impls "recognition". Meaning that some `!Send` types were still being showed as implementing `Send`. It was fixed in [this pull request](https://github.com/rust-lang/rust/pull/95069).

### Creating a parser for rustdoc search

This **huge** [pull request](https://github.com/rust-lang/rust/pull/90630) added a parser with a defined eBNF so that it can now provide errors and equivalents to help users writing search queries.

### A lot of UI fixes

 * The sidebar was badly displayed on mobile devices. Fixed in [#99713](https://github.com/rust-lang/rust/pull/99713).
 * Fixed display of the crate filter dropdown and put back missing border color on focused search input in [#99489](https://github.com/rust-lang/rust/pull/99489).
 * Another fix for the crate filter in [#99086](https://github.com/rust-lang/rust/pull/99086).
 * Fixed trailing whitespaces on the `where` clause in [#98526](https://github.com/rust-lang/rust/pull/98256).
 * Fixed trailing whitespaces on long declarations in [#98806](https://github.com/rust-lang/rust/pull/98806).
 * Fixed display of `<details>`/`<summary>` in doc blocks in [#97429](https://github.com/rust-lang/rust/pull/97249).
 * Fixed source code pages sidebar display in [#98671](https://github.com/rust-lang/rust/pull/98671).

### Improve rustdoc source code

Rustdoc has multiples stages where it transforms the information it gets from the compiler into information it can use to generate the documentation. The last step uses a trait called `Clean`. However, using this trait makes it complicated to actually understand what is the `Clean` implementation called. As such, we decided to remove it. Here are some pull requests making this cleanup:

 * [#99672](https://github.com/rust-lang/rust/pull/99672)
 * [#99638](https://github.com/rust-lang/rust/pull/99638)

### Improve performance by removing type fields

This [pull request](https://github.com/rust-lang/rust/pull/99598) removed fields from the `clean::Trait` struct. It allows to make the type lighter and only get this information when needed, allowing to improve performance.

And this [pull request](https://github.com/rust-lang/rust/pull/99559) removed a type from the `clean::ItemKind::KeywordItem` variant.

This [pull request](https://github.com/rust-lang/rust/pull/93963) replaced a field using `Option<DefId>` with a `bool` in the `clean::Type` struct, allowing to reduce the type size from 80 to 72 bytes, impacting all types which contained `clean::Type`.

This [pull request](https://github.com/rust-lang/rust/pull/94053) removed the `fields_stripped` field from a few types.

### Fix auto-expand in source code pages sidebar

In the source code pages, the sidebar contains a tree view for the files of the crate. It auto-expands the path to the current file. However, it was also opening all other paths. It was fixed in [#99373](https://github.com/rust-lang/rust/pull/99373).

### JSON output format fixes

The JSON output format had a lot of issues, mostly around reexports. The solution we picked was to stop inlining reexported items directly to prevent duplicates. It was done in these pull requests:

 * [#99287](https://github.com/rust-lang/rust/pull/99287)
 * [#98577](https://github.com/rust-lang/rust/pull/98577)
 * [#98611](https://github.com/rust-lang/rust/pull/98611)
 * [#98053](https://github.com/rust-lang/rust/pull/98053)
 * [#98166](https://github.com/rust-lang/rust/pull/98166)
 * [#98195](https://github.com/rust-lang/rust/pull/98195)

### Transform the settings menu into a "pocket" menu

We had a lot of buttons alongside the search input: one for picking a theme, one for the settings and one for the help. We tried for some time to remove this noise and finally found a way by merging settings and themes menus into one "pocket" menu.

It was done in [#96958](https://github.com/rust-lang/rust/pull/96958).

Then this [pull request](https://github.com/rust-lang/rust/pull/97089) improved the display of the items in the menu.

### Transform the help popup into a "pocket" menu

Until this [pull request](https://github.com/rust-lang/rust/pull/98297), when you clicked on the `?` button, a popup was displayed. It was displaying a popup. Since we already transformed the settings menu into a pocket menu, it didn't make much sense to keep this popup so it was turned into a pocket menu as well.

### Add macro support in jump to definition feature

On the source code pages, when there is a macro, you can now jump to its definition thanks to [#91264](https://github.com/rust-lang/rust/pull/91264).

### Add visual "notification" for users to know that the settings menu is loading

This [pull request](https://github.com/rust-lang/rust/pull/96704) added an animation when you click on the settings button until the menu is loaded to allow the users to know that something is being done in the background.

### Simplify theme CSS source code

For now, rustdoc themes need to re-implement all the CSS rules from `light.css` into the new theme. We have been switching to CSS variables to make this simpler to maintain:

 * [#98460](https://github.com/rust-lang/rust/pull/98460)
 * [#99152](https://github.com/rust-lang/rust/pull/99152)

### Add more semantic information to impl IDs

Each impl block has an ID. However, if you have more than one, the IDs will conflict and you will end up with `impl-1`, `impl-2`, etc. This [pull request](https://github.com/rust-lang/rust/pull/98939) added more information into the impl ID to make them more predictible.

### CSS cleanup

There some cleanups being done recently on the CSS:

 * [#99423](https://github.com/rust-lang/rust/pull/99423)
 * [#99237](https://github.com/rust-lang/rust/pull/99237)
 * [#99114](https://github.com/rust-lang/rust/pull/99114)
