---
layout: post
title: Contributions to the Rustdoc tool by Huawei Trusted Programming 
toc: true
---

Here is the list of the opensource contributions made by huawei employees on the [Rustdoc tool](https://github.com/rust-lang/rust/tree/master/src/librustdoc).

### (rustdoc) Codeblock tooltip position

The goal of this [pull request](https://github.com/rust-lang/rust/pull/83393) was to fix the position of the tooltip "i" which appears when a rust documentation codeblock is marked as "ignore" or "compile_fail". You can see screenshots directly in the [pull request](https://github.com/rust-lang/rust/pull/83393).

### (rustdoc) Add documentation for rustdoc GUI tests

There are multiple test suites to ensure that rustdoc is working as expected:
 * test/rustdoc: checks parts of the HTML and that some elements are present as expected
 * test/rustdoc-js: checks the documentation search
 * test/rustdoc-js-std: checks the documentation search (in the std specifically)
 * test/rustdoc-ui: checks the cli output (errors, warnings, etc)
 * test/rustdoc-json: checks the validity of the JSON output (you can generate either HTML or JSON)
 * test/rustdoc-gui: browse the generated HTML using a chrome instance (with the framework [browser-ui-test](https://github.com/GuillaumeGomez/browser-UI-test/))

This [pull request](https://github.com/rust-lang/rust/pull/83420) is about adding documentation about the **rustdoc-gui** test suite.

### (rustdoc) Add a button to copy the "use statement"

It's very common, when reading an item's documentation to want to then import it into your code to use it. This [pull request](https://github.com/rust-lang/rust/pull/83721) adds a button to do it.

### (rustdoc) Merge idents in paths to make source code pages DOM smaller

This [pull request](https://github.com/rust-lang/rust/pull/83992) ensures to not have a span for each part of a path in the source code pages (for example [here](https://docs.rs/sysinfo/0.17.0/src/sysinfo/lib.rs.html#7-283)). Before this change, for `a::b::c` we generated `<span>a</span>::<span>b</span>::<span>c</span>`, now we generate `<span>a::b::c</span>`.

### (rustdoc) Migrate toggles into full HTML

This [pull request](https://github.com/rust-lang/rust/pull/84754) and [this one](https://github.com/rust-lang/rust/pull/85074) convert JS-generated toggles into full HTML ones. It's part of a more global process to clean all the toggles that you can see described in [this issue](https://github.com/rust-lang/rust/issues/83332). The global idea being to remove more JS for faster rendering.

A "funny" side-effect is that it actually improves the doc pages in case you disabled JS on the rustdoc pages.

### (rustdoc) Remove unneeded call to with_default_session_globals

We recently realized that not only this function call was unneeded but also that it was messing up the spans. You can see the pull request [here](https://github.com/rust-lang/rust/pull/84953).

### (rustdoc) Improvement for rustdoc-gui test suite output and run

This [pull request](https://github.com/rust-lang/rust/pull/85038) and [this one](https://github.com/rust-lang/rust/pull/84990) improved the rustdoc-gui test suite by alphabetically sorting the test and run all tests instead of stopping at the first failure like it used to.

### (rustdoc) Improve search result DOM generation

It was discovered randomly that in some cases, the generated DOM was invalid (because of items' documentation). For more context, when using the rustdoc search, we generate the results with JS. This generation was mostly done using strings before, this [pull request](https://github.com/rust-lang/rust/pull/85540) changed it so that it now generates through browsers' API instead.

### (rustdoc) Sidebar unification

This [pull request](https://github.com/rust-lang/rust/pull/84834) unify the sidebar between modules and the other items, add the crates list on all items on all "levels" and remove a duplicate "location" information on modules.

### (rustdoc) Clean up HTML generated by rustdoc

Thanks to <https://github.com/rust-lang/rust/pull/84480>, we realized that the HTML (a.k.a. DOM) generated by rustdoc needed to be cleaned up. This [pull request](https://github.com/rust-lang/rust/pull/84703) is the clean up.

### (rustdoc) Fixes for new DOM

A lot of changes happened on rustdoc recently and we're now catching up on bugs and adding a lot of new tests since we now have GUI tests. Here is a long and non-exhaustive list:

 * Fix HTML handling in search results description: <https://github.com/rust-lang/rust/pull/86095>
 * Fix font weight on documentation: <https://github.com/rust-lang/rust/pull/86078>
 * Fix display for search results by removing unwanted margins and font-weight: <https://github.com/rust-lang/rust/pull/86040>
 * Fix toggle on trait methods: <https://github.com/rust-lang/rust/pull/85722>
 * Fix source code line number display and make it clickable again: <https://github.com/rust-lang/rust/pull/85148>
 * Fix border radius for doc code blocks in rustdoc: <https://github.com/rust-lang/rust/pull/85174>
 * Fix display for "implementors" section: <https://github.com/rust-lang/rust/pull/85256>
 * Fix invalid `input:disabled` CSS selector: <https://github.com/rust-lang/rust/pull/85367>
 * Fix escape key handling: <https://github.com/rust-lang/rust/pull/85438>
 * Fix invalid CSS rules for `a:hover` (it was highlighting instead of underlining): <https://github.com/rust-lang/rust/pull/85470>
 * Fix search result position handling when switching result tab: <https://github.com/rust-lang/rust/pull/85506>
 * Prevent tab title to "null" if the URL is a search one: <https://github.com/rust-lang/rust/pull/85509>
 * Remove a lot of dead JS code: <https://github.com/rust-lang/rust/pull/85548>
 * Fix search result display (the item was going over its description): <https://github.com/rust-lang/rust/pull/85551>
 * Put back special search result items information: <https://github.com/rust-lang/rust/pull/85568>
 * Fix "inherent implementations" display (they were collapsed by default, which was wrong): <https://github.com/rust-lang/rust/pull/85602>
 * Move special search result item handling from CSS to JS: <https://github.com/rust-lang/rust/pull/85631>

### (rustdoc) Improve generated DOM

We started using the `tidy` tool to ensure the HTML rustdoc generates is valid. The final part of this fix is in [this pull request](https://github.com/rust-lang/rust/pull/85972).

### (rustdoc) Better search result DOM generation

When you use rustdoc search system, it'll go through the items, find the best matches and then display them. The display part was generated inside a big string before, which allowed a lot of issues. Instead, it was replaced with much safer DOM generation using browsers' API to create DOM elements. You can see how in [this pull request](https://github.com/rust-lang/rust/pull/85540).

### (rustdoc) Don't mark "safe" intrinsics as unsafe

Some rust intrinsics are safe to be used. This [pull request](https://github.com/rust-lang/rust/pull/86327) propagates this change to rustdoc.

### (rustdoc) Add --nocapture option to rustdoc

Until [this pull request](https://github.com/rust-lang/rust/pull/86230) was merged, there was no way to see the output of the doctests. This is now possible by using the `--nocapture` option when running `rustdoc --test`.

### (rustdoc) Add support for tuple struct field documentation

Before this [pull request](https://github.com/rust-lang/rust/pull/87451), it was not possible to do this:

```rust
pub struct Tuple(
    /// Not this.
    u32,
    /// Not that either.
    i8,
);

// Nor this:

pub enum Enum {
    Tuple(
        /// Not this.
        u8,
    /// Not that either.
        char,
    ),
}
```

### (rustdoc) Generate links to definition in rustdoc source code pages

This [pull request](https://github.com/rust-lang/rust/pull/84176) adds a the possibility to jump to an item definitions from the rustdoc source code pages (you can see a video in the pull request description). It got a lot of support from rust users as you can see from this twitter feed:

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">I&#39;m very excited to show some feature I&#39;m working on in <a href="https://twitter.com/rustlang?ref_src=twsrc%5Etfw">@rustlang</a>&#39;s rustdoc: ever wanted to be able to jump to a type definition from the source code pages directly? It&#39;ll be possible soon! More to come! Here is a small preview: <a href="https://t.co/ICPXH35Q8V">pic.twitter.com/ICPXH35Q8V</a></p>&mdash; Guillaume Gomez (@imperioworld_) <a href="https://twitter.com/imperioworld_/status/1379506735094857728?ref_src=twsrc%5Etfw">April 6, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

### (rustdoc) Improve intra-doc errors

The intra-doc feature in rustdoc allows to generate links to an item without giving a full path. For example:

```rust
/// I link to [Bar].
pub struct Foo;

/// I link to [Foo].
pub enum Bar {
    U,
}
```

In this case, the rustdoc will generate links to `Foo` and `Bar` on its own.

This [pull request](https://github.com/rust-lang/rust/pull/87285) improves the error in case rustdoc cannot generate the link on its own.

### (rustdoc) Fix rendering of reexported macros 2.0 and fix visibility of reexported items

Macros 2.0 adds a new syntax to declare macros. Rustdoc didn't make the difference between the new and old macros and rendered both the same way. This [pull request](https://github.com/rust-lang/rust/pull/86841) fixed it and also fixed the visibility rendering on reexported items.
